import pandas as pd

# Cria lista com os nomes dos workbooks e outra com nomes das worksheets em cada workbook

workbooks = !ls '/home/mribeiro/Downloads/plans_gn'
df_final = pd.DataFrame()

# Abre e edita cada planilha do arquivo para salvar só os dados necessários em um dataframe geral

for i in workbooks:
    worksheets = list(pd.ExcelFile(r'/home/mribeiro/Downloads/plans_gn/' + i).sheet_names)
    for n in worksheets:
        if (n == 'Registros Novos ') or (n == 'PRODUTOS'):
            pass
        else:
            manter_coluna = ['Matéria-prima', 'Lote', 'Qtde', 'Data', 'O.P.', 'Produto', 'Produção ou Correção']
            df = pd.read_excel(r'/home/mribeiro/Downloads/plans_gn/' + i, sheet_name = n)
            n = str(n).upper().replace('CORREÇÃ', '- CORREÇÃO')
            df['Data'] = format(df.iat[6,1], "%d/%m/%Y") 
            df['O.P.'] = n[(n.find('2')):(n.find('2') + 3)]
            df['Produto'] = n[4:n.find('-')]
            df['Produção ou Correção'] = 'Correção' if ('CORREÇÃ') in n else 'Produção'
            df = df.rename({df.columns[0]: 'Matéria-prima', df.columns[1]: 'Lote', df.columns[2]: 'Qtde'}, axis = 1)
            df = df[14:(df.index[df['Matéria-prima'] == 'Total'][0])]
            df = df.loc[:, manter_coluna]
            df_final = df_final.append(df)

# conversão para xlsx

df_final.to_excel(r'/home/mribeiro/Downloads/listaFinal.xlsx')
